<!DOCTYPE HTML>
<html>
 <head>
  <meta charset="utf-8"/>
  <title>
   Made with Remarkable!
  </title>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/github.min.css" rel="stylesheet"/>
  <style type="text/css">
   body{background:#000;font-family:Georgia,Palatino,serif;color:#EEE;line-height:1;padding:30px;margin:auto;max-width:42em}h1,h2{text-align:center}h1,h2,h3,h4{font-weight:400}h1,h2,h3,h4,h5,p{margin-bottom:24px;padding:0}h1{font-size:48px}h2{font-size:36px;margin:24px 0 6px}h3{font-size:24px}h4{font-size:21px}h5{font-size:18px}a{color:#61BFC1;margin:0;padding:0;text-decoration:none;vertical-align:baseline}a:hover{text-decoration:underline}a:visited{color:#466B6C}ol,ul{padding:0;margin:0}li{line-height:24px}li ul{margin-left:24px}ol,p,ul{font-size:16px;line-height:24px;max-width:540px}pre{padding:0 24px;max-width:800px;white-space:pre-wrap}code{font-family:Consolas,Monaco,Andale Mono,monospace;line-height:1.5;font-size:13px}aside{display:block;float:right;width:390px}blockquote{border-left:.5em solid #eee;padding:0 2em;margin-left:0;max-width:476px}blockquote cite{font-size:14px;line-height:20px;color:#bfbfbf}blockquote p{color:#666;max-width:460px}hr{width:540px;text-align:left;margin:0 auto 0 0;color:#999}button,input,select,textarea{margin:0;vertical-align:baseline}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}button,input[type=button],input[type=reset],input[type=submit]{cursor:pointer;-webkit-appearance:button}input:not([type=image]),textarea{-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}input[type=search]{-webkit-appearance:textfield;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}input[type=search]::-webkit-search-decoration{-webkit-appearance:none}input,label,select,textarea{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:13px;font-weight:400;line-height:normal;margin-bottom:18px}input[type=checkbox],input[type=radio]{cursor:pointer;margin-bottom:0}input[type=password],input[type=text],select,textarea{display:inline-block;width:210px;padding:4px;font-size:13px;font-weight:400;line-height:18px;height:18px;color:gray;border:1px solid #ccc;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px}input[type=file],select{height:27px;line-height:27px}textarea{height:auto}:-moz-placeholder{color:#bfbfbf}::-webkit-input-placeholder{color:#bfbfbf}input[type=password],input[type=text],select,textarea{-webkit-transition:border linear .2s,box-shadow linear .2s;-moz-transition:border linear .2s,box-shadow linear .2s;transition:border linear .2s,box-shadow linear .2s;-webkit-box-shadow:inset 0 1px 3px rgba(0,0,0,.1);-moz-box-shadow:inset 0 1px 3px rgba(0,0,0,.1);box-shadow:inset 0 1px 3px rgba(0,0,0,.1)}input[type=password]:focus,input[type=text]:focus,textarea:focus{outline:0;border-color:rgba(82,168,236,.8);-webkit-box-shadow:inset 0 1px 3px rgba(0,0,0,.1),0 0 8px rgba(82,168,236,.6);-moz-box-shadow:inset 0 1px 3px rgba(0,0,0,.1),0 0 8px rgba(82,168,236,.6);box-shadow:inset 0 1px 3px rgba(0,0,0,.1),0 0 8px rgba(82,168,236,.6)}button{display:inline-block;padding:4px 14px;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:13px;line-height:18px;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;-webkit-box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05);-moz-box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05);box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05);background-color:#0064cd;background-repeat:repeat-x;background-image:-khtml-gradient(linear,left top,left bottom,from(#049cdb),to(#0064cd));background-image:-moz-linear-gradient(top,#049cdb,#0064cd);background-image:-ms-linear-gradient(top,#049cdb,#0064cd);background-image:-webkit-gradient(linear,left top,left bottom,color-stop(0%,#049cdb),color-stop(100%,#0064cd));background-image:-webkit-linear-gradient(top,#049cdb,#0064cd);background-image:-o-linear-gradient(top,#049cdb,#0064cd);background-image:linear-gradient(top,#049cdb,#0064cd);color:#fff;text-shadow:0 -1px 0 rgba(0,0,0,.25);border:1px solid #004b9a;-webkit-transition:.1s linear all;-moz-transition:.1s linear all;transition:.1s linear all;border-color:#0064cd #0064cd #003f81;border-color:rgba(0,0,0,.1) rgba(0,0,0,.1) rgba(0,0,0,.25)}button:hover{color:#fff;background-position:0 -15px;text-decoration:none}button:active{-webkit-box-shadow:inset 0 3px 7px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.05);-moz-box-shadow:inset 0 3px 7px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.05);box-shadow:inset 0 3px 7px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.05)}button::-moz-focus-inner{padding:0;border:0}mark{background-color:#ff69b4}table{border-collapse:collapse}td,th{border:1px solid #fff;padding:.5rem;text-align:left}
  </style>
 </head>
 <body>
  <style type="text/css">
   html {
        overflow: auto;
}
  </style>
  <h1 id="about-me">
   About me
  </h1>
  <ul>
   <li>
    Simon Hickinbotham: Archaeology / Comp Sci staff memeber
   </li>
   <li>
    Ecologist turned programmer
   </li>
   <li>
    Computer vision/ Evo alg
   </li>
   <li>
    bioarch - R developer - why I learned how to do this
   </li>
   <li>
    Comments on this methodology are welcome!
   </li>
  </ul>
  <h1 id="what-well-do">
   What we’ll do
  </h1>
  <p>
   <em>
    From R (or “unsupported” in Rstudio)
   </em>
  </p>
  <ul>
   <li>
    install devtools
   </li>
   <li>
    create github account &amp; repo
   </li>
   <li>
    lay out an R package within a local git repo
   </li>
   <li>
    build the package
   </li>
   <li>
    versioning
   </li>
   <li>
    add help
   </li>
   <li>
    add C code library
   </li>
   <li>
    add datasets
   </li>
   <li>
    …updating github as we go....
   </li>
  </ul>
  <p>
   <em>
    I suggest you work in pairs so that you can share packages with each other
   </em>
  </p>
  <hr/>
  <h1 id="devtools">
   Devtools
  </h1>
  <ul>
   <li>
    A really handy package for developing packages
   </li>
   <li>
    Automates a lot of the process for you
   </li>
   <li>
    Available from CRAN:
   </li>
  </ul>
  <pre><code>&gt; install.packages("devtools")
</code></pre>
  <h1 id="github">
   Github
  </h1>
  <ul>
   <li>
    Free hosting of (public) projects
   </li>
   <li>
    email needed
   </li>
   <li>
    Other private (UoY) repositories may be available
   </li>
   <li>
    make a github account now if you want to follow along…
   </li>
  </ul>
  <h1 id="a-github-r-package-repository">
   A github r-package repository
  </h1>
  <ul>
   <li>
    This means we always have a backup
   </li>
   <li>
    we can share our package with others
   </li>
   <li>
    Easiest way is this:
    <ul>
     <li>
      Make an empty repository
     </li>
     <li>
      Clone it to a
      <em>
       local
      </em>
      repo
     </li>
     <li>
      Save files / folders there
     </li>
     <li>
      push to github.
     </li>
    </ul>
   </li>
  </ul>
  <h1 id="make-an-empty-repository">
   Make an empty repository
  </h1>
  <p>
   <em>
    See github; Initialise with the following:
   </em>
  </p>
  <ul>
   <li>
    <code>
     README.md
    </code>
   </li>
   <li>
    <code>
     LICENSE.md
    </code>
   </li>
   <li>
    <code>
     .gitignore
    </code>
   </li>
  </ul>
  <h1 id="make-a-local-clone">
   Make  a local clone
  </h1>
  <ul>
   <li>
    A copy of the git repo on your hard drive
   </li>
   <li>
    Do you have git? (probably)
   </li>
   <li>
    Pick a suitable directory - it can be anywhere - then:
   </li>
  </ul>
  <p>
   <em>
    From the command line! (not from R)
   </em>
  </p>
  <pre><code>$ git clone https://github.com/github_username/repo_name
</code></pre>
  <ul>
   <li>
    e.g.:
   </li>
  </ul>
  <pre><code>$ git clone https://github.com/franticspider/rpkgtalk
</code></pre>
  <ul>
   <li>
    Now we can work on the package locally, and upload in stages.
   </li>
  </ul>
  <h1 id="structure-of-a-github-package">
   Structure of a github package
  </h1>
  <p>
   <em>
    My preferences are these:
   </em>
  </p>
  <ul>
   <li>
    Create the package in a
    <em>
     sub-
    </em>
    directory of the repo
   </li>
   <li>
    Gives a distinction between
    <em>
     developers
    </em>
    and
    <em>
     users
    </em>
    <ul>
     <li>
      <strong>
       developers
      </strong>
      clone the repo via git
     </li>
     <li>
      <strong>
       users
      </strong>
      install the packge via devtools (see later)
     </li>
    </ul>
   </li>
   <li>
    Allows readme, tests, install scripts etc. to be separate
   </li>
   <li>
    devtools allows for this when installing a package.
   </li>
  </ul>
  <h1 id="make-a-basic-r-package">
   Make a basic R package
  </h1>
  <ul>
   <li>
    <a href="https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/">
     https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/
    </a>
   </li>
  </ul>
  <pre><code>&gt; require(devtools)
&gt; setwd("~/git/rpkgtalk")
&gt; create("mypkg1")
</code></pre>
  <ul>
   <li>
    have a look at the folder structure on your filesystem…
   </li>
  </ul>
  <h1 id="add-a-function">
   Add a function
  </h1>
  <ul>
   <li>
    similar to creating a standard R function file
   </li>
   <li>
    store in the
    <code>
     R
    </code>
    sub-directory
   </li>
   <li>
    let’s do that now…
   </li>
  </ul>
  <h1 id="create-an-r-function">
   Create an R function
  </h1>
  <ul>
   <li>
    Let’s make a toy function (copying Hilary Parker)
   </li>
  </ul>
  <pre><code>cat_function &lt;- function(love=TRUE){
    if(love==TRUE){
        print("I love cats!")
    }
    else {
        print("I am not a cool person.")
    }
}
</code></pre>
  <h1 id="add-help">
   Add help
  </h1>
  <ul>
   <li>
    <strong>
     THIS IS NOT DIFFICULT
    </strong>
   </li>
   <li>
    Most of the help will be constructed for you “for free”
   </li>
   <li>
    Just put comments above the function in question
   </li>
   <li>
    Special keywords tell devtools/roxygen how to make the helpfile:
   </li>
   <li>
    <code>
     #' @param
    </code>
    <em>
     a parameter of the function
    </em>
   </li>
   <li>
    <code>
     #' @keywords
    </code>
    <em>
     will find the help for the function when you do
    </em>
    <code>
     &gt; ??keyword
    </code>
   </li>
   <li>
    `#’ @export
    <em>
     tells devtools to make this function available
    </em>
   </li>
   <li>
    <code>
     #' @examples
    </code>
    <em>
     gives example function calls
    </em>
   </li>
  </ul>
  <pre><code>#' A Cat Function
#'
#' This function allows you to express your love of cats.
#' @param love Do you love cats? Defaults to TRUE.
#' @keywords cats
#' @export
#' @examples
#' cat_function()
</code></pre>
  <h1 id="git-commits">
   Git commits
  </h1>
  <ul>
   <li>
    it is important to ‘stash’ your work regularly
   </li>
  </ul>
  <p>
   <em>
    From outside R
   </em>
  </p>
  <ul>
   <li>
    There are three git commands you need to remember
   </li>
  </ul>
  <pre><code>$ git add .
$ git commit
$ git push
</code></pre>
  <h1 id="creating-a-release">
   Creating a release
  </h1>
  <ul>
   <li>
    Important to mark milestones in development with
    <em>
     Releases
    </em>
    (or tags)
   </li>
   <li>
    This is easiest done within github…
   </li>
   <li>
    you can then use devtools to install a specific release
   </li>
   <li>
    do a “pull” after creating the tag:
   </li>
  </ul>
  <pre><code>$ git pull
</code></pre>
  <h1 id="accessing-releases">
   Accessing releases
  </h1>
  <ul>
   <li>
    This is how you share your package with other users
   </li>
   <li>
    Useful for testing, or while a newer version is being developed
   </li>
   <li>
    If necessary,
    <em>
     remove your current version
    </em>
   </li>
  </ul>
  <pre><code>&gt; remove.packages(mypkg1)
</code></pre>
  <ul>
   <li>
    Now use devtools’
    <code>
     install_github
    </code>
    command:
   </li>
  </ul>
  <pre><code>&gt; require(devtools)
&gt; install_github("franticspider/rpkgtalk", subdir = "mypkg1", ref = "0.2.0")
</code></pre>
  <ul>
   <li>
    If you just want the latest version:
   </li>
  </ul>
  <pre><code>&gt; require(devtools)
&gt; install_github("franticspider/rpkgtalk", subdir = "mypkg1")
</code></pre>
  <hr/>
  <h1 id="make-a-compile-script">
   Make a compile script
  </h1>
  <ul>
   <li>
    an advantage of building your package in a sub-directory is that you can
    <br/>
    store the compile script in the repository too:
   </li>
   <li>
    Create a file called
    <code>
     install.R
    </code>
    and put it in the top-level git directory
   </li>
   <li>
    Add these contents:
   </li>
  </ul>
  <pre><code>#These are the libraries you need to build a package:
require("devtools")
require(roxygen2)

#Build the help files:
setwd("mypkg1")
document()

#Compile
setwd("..")
install("mypkg1")

#reload
require("mypkg1")
</code></pre>
  <ul>
   <li>
    you can just run this from R (make sure you setwd() correctly)
   </li>
  </ul>
  <h1 id="first-commit-to-github">
   First commit to github
  </h1>
  <ul>
   <li>
    Huge simplification here, but…
   </li>
   <li>
    three steps:
   </li>
  </ul>
  <pre><code>$ git add .
$ git commit
$ git push
</code></pre>
  <h1 id="tagging-versioning">
   Tagging / Versioning
  </h1>
  <ul>
   <li>
    do within github - keeps things simple
   </li>
   <li>
    you can download a specific tag with devtools (see later)
   </li>
  </ul>
  <h1 id="accessing-releases_1">
   Accessing releases
  </h1>
  <ul>
   <li>
    Useful for testing, or helping people with problems
   </li>
   <li>
    First, remove your current version
   </li>
  </ul>
  <pre><code>&gt; remove.packages(mypkg1)
</code></pre>
  <ul>
   <li>
    Now use devtools’
    <code>
     install_github
    </code>
    command:
   </li>
  </ul>
  <pre><code>&gt; require(devtools)
&gt; install_github("franticspider/rpkgtalk", subdir = "mypkg1", ref = "0.2.0")
</code></pre>
  <h1 id="add-c-code">
   Add C code
  </h1>
  <ul>
   <li>
    A whole can of worms!
   </li>
   <li>
    Useful for legacy code, and can be faster
   </li>
   <li>
    basic principles are simple:
    <ul>
     <li>
      write C code in the
      <code>
       src\
      </code>
      sub-directory
     </li>
     <li>
      Only pass in pointers to functions
     </li>
     <li>
      Write a wrapper function in R
     </li>
     <li>
      Add compile instructions to the compile script
     </li>
    </ul>
   </li>
  </ul>
  <h1 id="c-functions">
   C functions
  </h1>
  <p>
   <a href="http://r-pkgs.had.co.nz/src.html">
    http://r-pkgs.had.co.nz/src.html
   </a>
  </p>
  <ul>
   <li>
    the function arguments must all be pointers
   </li>
   <li>
    all allocated memory must be freed
   </li>
   <li>
    printfs/writing to file is not good - can’t be controlled in R
   </li>
   <li>
    (Looking at ways to build a test rig outside the package directory)
   </li>
  </ul>
  <h1 id="c-function-example">
   C function example
  </h1>
  <pre><code>void halve_cats(int *ncats, int *catarray, double * halfcats, int *errflag){

    int i;

#ifdef DEBUG_R  
    printf("In C, we are going to halve %d cats\n",ncats[0]);
#endif  
    for(i=0;i&lt;ncats[0];i++){
        halfcats[i] = (float) catarray[i]/2.2;
#ifdef DEBUG_R  
        printf("ca = %d, hc = %0.3f\n",catarray[i],halfcats[i]);
#endif
    }
    errflag[0]=120;
}
</code></pre>
  <h1 id="calling-the-c-from-r">
   Calling the C from R
  </h1>
  <ul>
   <li>
    write a
    <em>
     wrapper function
    </em>
   </li>
   <li>
    handles the “raw” arguments
   </li>
   <li>
    calls the function
   </li>
   <li>
    devtools
    <code>
     @useDynLib
    </code>
    flag indicates the C library
   </li>
  </ul>
  <h1 id="calling-the-c-from-r-example">
   Calling the C from R - example
  </h1>
  <pre><code>#' Wrapper for the  'halve_cats' C function
#' @param ncats number of cats to halve
#' @keywords cats
#' @useDynLib mypkg1
#' @export
#' @examples
#' halve_cats(5)
halve_cats &lt;- function(ncats){

    ca &lt;- as.integer(runif(ncats,1,20))
    hc &lt;- vector(length=ncats)

    message(sprintf("We are going to halve %d cats",ncats))

    errflag&lt;-0
    result&lt;-.C("halve_cats",as.integer(ncats),as.integer(ca),as.double(hc),as.integer(errflag))

    return (result)

}
</code></pre>
  <h1 id="building">
   Building
  </h1>
  <ul>
   <li>
    No different! - just run
    <code>
     install.R
    </code>
   </li>
   <li>
    a NAMESPACE file will be created that states the DynLib name
   </li>
  </ul>
  <h1 id="second-commit-to-github">
   Second commit to github
  </h1>
  <pre><code>$ git add .
$ git commit
$ git push
</code></pre>
  <h1 id="source-data">
   Source data
  </h1>
  <p>
   <a href="http://r-pkgs.had.co.nz/data.html">
    http://r-pkgs.had.co.nz/data.html
   </a>
  </p>
  <ul>
   <li>
    It is useful to provide data with your package
   </li>
   <li>
    Three types:
    <em>
     Exported
    </em>
    ,
    <em>
     Internal
    </em>
    and
    <strong>
     Raw
    </strong>
   </li>
   <li>
    Raw data goes in
    <code>
     inst/extdata
    </code>
   </li>
   <li>
    accessed like this:
   </li>
  </ul>
  <pre><code>&gt; filename &lt;- system.file("extdata", "2010.csv", package = "testdat")
&gt;data &lt;- read.table(filename,sep=`,`)
</code></pre>
  <h1 id="third-commit-to-github">
   Third commit to github
  </h1>
  <pre><code>$ git add .
$ git commit
$ git push
</code></pre>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/highlight.min.js">
  </script>
  <script>
   hljs.initHighlightingOnLoad();
  </script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
  </script>
  <script type="text/javascript">
   MathJax.Hub.Config({"showProcessingMessages" : false,"messageStyle" : "none","tex2jax": { inlineMath: [ [ "$", "$" ] ] }});
  </script>
 </body>
</html>